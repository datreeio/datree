language: go
go:
  - "1.17"

os: osx
osx_image: xcode12.5

before_script:
  - HOMEBREW_NO_AUTO_UPDATE=1 brew install awscli
  - aws --version

script:
  - bash ./scripts/upload_install_scripts.sh
  - echo $RELEASE_DATREE_PROD
  - "travis_wait 60 sleep 3600 &"
  - export GO_BUILD_TAG=$(bash ./scripts/define_build_tag.sh)
  - go build -tags $GO_BUILD_TAG
  - go test ./...

before_deploy:
  - curl -sfL https://git.io/goreleaser | VERSION=v$GORELEASER_VERSION sh -s -- check
  - HOMEBREW_NO_AUTO_UPDATE=1 brew install mitchellh/gon/gon
  - git config --global user.email "builds@travis-ci.com"
  - git config --global user.name "Travis CI"
  - git remote set-url origin https://datree-ci:$GITHUB_TOKEN@github.com/datreeio/datree.git
  - bash ./scripts/install_svu.sh
  - echo $(svu --version)

deploy:
  - provider: script
    skip_cleanup: true
    script: bash ./scripts/deploy_release_candidate.sh
    on:
      branch: main
      condition: $RELEASE_DATREE_PROD != true
  - provider: script
    skip_cleanup: true
    script: bash ./scripts/release.sh
    on:
      branch: main
      condition: $RELEASE_DATREE_PROD = true

env:
  global:
    #GITHUB_TOKEN
    - secure: "OQTTfOMNYFxGNkizM7bhK3OJXUntazxaQ6rliRO327fRnMPacK/pswMIwUjjzwTwLV8nVIvACSIWmo/45SeJtLVcHsle3RBn0OZFmgMFjySkLldP71t/4HzV3ef24px9JNX/FO6kQ7tqzzS7SRwlekL4v/r6K8ro1kqmFDLQ2uibgSXqkI7rNwPP56L5+QTX46pA2113NnGpywAm/K33ky40Fb2QclDH41ax+Jm7zyDy1ry0d/T9db+GBOnBsfkqkuBiBDvJ2tp4n0KbvAIt870O8Ey9jB7MUkwdGKH/0ZlEFXihEmKIVn9pih5t8EFZzVxdPK+aJ3SHeqWAu9v0Iy1lsxs1je6fIkhA5hkHk9Hz4mgRrwiGRG1d25sBoNegnu0uA5Iowtwp4Rp7lTfDJSdazTW7W3L5+qzd9b1LA7GfIlATcSwDrPicf6RBX0r2eb0o2fiFi/B24X8J84CAmdnhlBjGYhoKdBZv3+ngopZAJNbbclD1YKMBhVEfjVGQMDOm6yVejIrPWq1asupX+JEpF4/myLXilooUKt2Znx01EG2UVZ31o6e5m3Hn/XWa5z5HR/zsYTozLUFe0kbJvBVwy4v/8YgUyoGGaxAifs6Eh3rmKzmQLa8eyZjIIUAibOd19uL7ZZSGAvKDr93N/8rlZnHA0PRsDNhNxVyCFu8="
    - GORELEASER_VERSION="0.155.1"
    #AC_USERNAME
    - secure: "eyz1nelBEtNDwYYXPn5X8Fh76q6tXudD7Z6qpu/0I8c4dACg0zK2h2BwzetVoDQZ6+E1nzWS6raaSOpXAzn/ezB7lb0zEWCoSjsuCxN7LiKikQn1rLWg7SNOYF2HJYENJLUVeBElHAcZOVXFa/G4u4Djq1lDNRqQaKlZ8EKhJswMCqa9gyo9oTvWiWuWXbI33aU6fFGpj/BH5ZxQPupA1uFPYLalt2cxB4D7SDGoIdDx5uUedzcPC2vxq9H5Qh0Lj6QdJ6Xq0RHZZw9TEKHJlCM1pyjWsFmAX/SEmsahc2RSExm6biOGjiorzDvtW0nF3MmZfz9k4+M24lSTLh/Lpvc+JAkRIRiv7vegvA9f5am3WbUESzFA5CfZWbn7uH4gtQoguPNQXBKe2a/nkHgQciKTntqrLiiQp+FpxH+u5AAQPkPLhhbPHfGH/CL8GfrCtRBL13GXkfVK093NXWmPqKb7GOIwTkmc9itocdWxLwMJpCnUf0dSRnmBefg2N65Uz0EsdGQMeRmZNcY0F3NvSOxhi1RN84LuiKlXeJa0jNiaSplS/jZNpRvWPlpg5oj5M5AqjF0gL8Mt6BdB7JsbGX9VIE4RjMmkGhshkb5hZk3TqRozAxqLw4q+NePyiKmCzax5KQIj0CuDDqxU2PZYFOG6Mun/f4alU2M86zzcc1M="
    #AC_PASSWORD
    - secure: "KWpsLZ3fPSDa4dZGzVpIQjzhxmhqSYI4dbgFs+NmteBB7hLRpMP6gjLy1BAoVW74jMr8Mo7ThGDRHq9leemrwplJHIrvmoNBl2l96rmOC/+W8IoFThpFIJxNUyqudQkFO0pDMH31F7WGUouzXaMyzM1CZI2lSeBmS9XNKkgWDbVuKb4703GEzfNG8LBn9vMJns4ZYAOSK8aAQi4alo9dR8emNg2o27xshoXG25vCz7hp9N9+1+h1yP7QLLlfD+ZV3IvO8hKYfm9eb36rARsOEt5059gBs2jeVcKxYJn6bWnlgzrSIMbpSGbUvuDkiT6sllPt73GQKQ5k7n7qhYUxc8/qL8xanGutEdyCxoU5MJ1l42T9KoLNmCboS6FDWqEeZ2hLOL9rPQyWOwZlKkviczKNAvtEaqK94GX2ARiKkmIA/sJcCqACFM3HeSOxxlrBl4K07fX8sGheuU1We33PU1IYPmeYqFwECciuGwFgOqVDrmLcFr20C9X0gDx3WQzutmLf5YVia2ItvXbohTe3Cg3y5b4ECZ5YtW9WtSazkY+zfAtMloe3xpRdz7lahSe7YPdfwef61mYcMI9+PzImpN0JL/FCd6kvI+mNocdY4PB7RD5G6ozBa5qJFtEFWlJhqyGOcJRNEJt/UvSaFeKV7XV6PUqyxAdZHcga5VERBSs="
    #P12_PASSWORD
    - secure: "eSkV14fXLnTIX/QGfrzUMACLCgNICEGxhS4AX+UCYnhNKyhOvXQjWJVOHnwuy4Oon75Ueev3PiUTlZBviPWZsAiy6VMpxUA5R149BtpQjUBfvzugA04ooxn6BD+zssIpSnld8VFENxNLRTzMcOyHyQAiwbKIG+TMOGcD8rYR58zJ60DispXY0otg+R/MEofcGXgb59bgD406kcUcEmBKRamE0oU1Xk0TxWrTJg3n7IM34qfPc2KUuO5DdPaxuOvfJ++b9YDyH4n0GFKMW6fuHxoDjMT7O6s2WrYlx+PF294RKiiVV1yCMhDvszu7uMkDgmWbZasmaj6ENBZ6b/RD0PNXHYwh/WvertL2y0waCfAmB9ULk1WYuFOvoqni+jYbcf7fMlLG06xOVF9JKakP1MOBy/K1ESJnOvvl5kpjiSJxK6y/KEcIP9A/RFNdZQX+1pYvPnFk+9IIAtcnE361fu66+E9/HO5yv9BcSiQhQMWiajNnfMlSNEy3vtSEHYovhwo3pfBtgRDlvYxeRQnmjpZH1UjLFhVrq6/qfQGGAkA4eu9uoKuyg9Mf7LFnUhOeknxNZe8eBGHhQ6zMIVzjV72vVSpx1fbUcTHhet+AMCS9fP5NgqOtTTNZ65wIWuwXJAh8jfed3tJ4qTL3GHmnVj/0nSLVIFISy8rwMWb00Cw="
    # AWS_ACCESS_KEY_ID
    - secure: "SL0eva6KKqvnvz9xzvDqm7LecnqjPw6Dia2rtrK5bH73cILupmAAblQtAUfbYwgqTu05rCP/b2TA8GzDVNV7lzlAbzaAt43Z1YExLxeJTGSdBPJU4SF1LqPWRDyEffpAtUV2FqIFgzRoM3OvM7NWmSblGlVKDVdQwYYiq56QOSim9fTJ9OgchugYDwq3rRce+vNhdBjkha6b9PyASkCg/vTZHfOcjDyOQ1ImEwH4SvBF+W++1qxeG49TaZrQ7F68hD6+q0uwGdc649s3HRgvIBmOiLBZQ3hCwzJHsnoApKZyXNwR442AmviaPqkXee+f0x9RLwORtkxEp3QcmaOAyCyEzEMmH6tCwOiuAQYNdOUn+eA9viwfpCdzja3nJ6lqkn4aWAObFD9C5mo28DxHzZGTrnyRxo6pAiCgftqJCNFVTyEhU/iQ/ALDTE0hM0leQtMTivNVotJnLiPPaf4JYm8kx3plGb0r1z507Vh9V86rI9xxGHK4M03rhC4rqyp2HEmq7xsOGxn7pKc93aeyF3BCdBTasoolLvX+rwJGLknw5bxdl2csTDZtkBK7Jn4409gKnZtUMJ2IwiJpwQytRJRnAnqpDOKNtXx0DRE/yQVamNCoGFjVI6hyV3WYAWApom5Jd406D+YCnNvwVPYNGskJBMICbokQyaZQZjvZ3Vw="
    # AWS_SECRET_ACCESS_KEY
    - secure: "IAhTNvHjtcMFavW+Lf4UaPL0dPOGSeb69bz0CQwNIEMRN0I7DfFGDP/xv+/iMZFJ++zBcTQW0/jH84RBnPetpFaopv1wHUoNZsPALwAgJZBJu2O00V7wkjaM8+P53oGuVJzoVgF5fhhmGh3ihlGbZqTvyT62TjvhdBioMF2lwbb7VdhqONSFiWXjMX01cm6MnZNlg0ftsDcLDl8qLw9zpz57bTUNXu/108LpRofa8R33rN9NYF/vsCRk6NQdU6uZjqVL2yh0LTrr05cYeh94eg9Kf8MxqckhRTOpkPVPWCb8BofQUjZqqYWe8zdTtwU0TMqHBs4wFwGgSqZOwty/QTUQsmeAmveXwjZd65JX2aOTLWFyFu79pJ3j8Dkbv/fBIOgNPVmlSP5lZaT/HxwjvKw9wUfaf2dVkShECLlhHNnVCgeE7YYuvDBQDtoolwAWwXQVxnkUrOmUa8eFoNjnuU/5O9sF6a+U6BJTEMSdwpDh7fqKcD4dsS81uAZafeLOm+qQFTm+Xn0M8lPzLx7u4S3/dSYUaU7Vk/xtvEr6Lzh08qTp/bcQM00EUch/a7jMdoLTxpLS7cAgJyK7zuXN0ZmThzy1KvU8vTg99gNQekpg3xyOmr34/X6xxWp+KaV+/PC7B1YgFFlfSJE1NoBmYrBmtkhXx8TI45os103h+YI="
    #CLOUDFRONT_DISTRIBUTION_ID
    - secure: "AGWcbtnvWQlxZtFXkoeM/jtKGVbSOW7KslGGhFFCl4kWpnBdLRdq0JsOXSJfLl7Tnmf8XdaMA0fjiG+9iTP+FA8xjs4+26hguMJD/igVA9orag+fP9Kq0IiGg2h+oU0AIfd7ap0PUN3gmLi6nAH5roJSecUPS0y0QFquyRXgmqxqRGtZfeG5l6i+ZAt/zYnRfsufktIwpYuOC+Z/X713bn4RrkZ0i0nDpZcI00ddksuVnjkaxLr+HhXshBoM1vAVAbtTPFPxa+3SDWcDCD64uprargiUEjtxKrUQEzyBIvAufsbtazuFw5V6YV3iZuLwhfBC/MpfyuaGb2QZs4k8wK0OfBH+/OIOyq6UKxZp5vQe6+zqtgLtJPHw0cWxodyeuigl6wxLtqbuvHNI13h9xFLncKtZjDaxr95juL996qh6/37/sF7mEmBP+h1l1YULaZCsPxpTU+RgX8jW/kYOYj+kefeAl7lxPPp0KZOJf+pgYvad7xK0ovps2FjJqDz5ZaequmJkUk8YnUo0ETt6sPGNkvhmtLM6T2U2iNSxMtaAaSANszqkwMen+VJ+aLP95BwpHCMO0U2DsCsY60gaw0MNugxuNsIkisX/NW8fiUn4Sg7pbO7XHRo6BwTUN/i4SRNUeb9VWQOpvzUj7uVcIJ3hSgfS3THcA0ZxgcFTMjo="
